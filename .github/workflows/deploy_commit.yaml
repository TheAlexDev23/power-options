name: Commit Deployment

on:
  push:
    branches:
        main

jobs: 
    check_and_format:
        name: cargo check and clippy
        runs-on: ubuntu-24.04
        # env:
        #     PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig
        steps:
            # Uninstall packages before installing from unstable
            # - run: sudo apt-get remove -y pkg-config glib2.0 libglib2.0 libglib2.0-dev libgtk-4-1 libgtk-3-0 libgtk-4-dev libgtk-3-dev libwebkit2gtk-4.0-dev libadwaita-1-dev | true
            # - run: sudo apt-get remove -y pkg-config libglib2.0-dev libgtk-4-dev libgtk-3-dev libwebkit2gtk-4.0-dev libadwaita-1-dev base-files || true
            # - run: echo "deb [trusted=yes] http://deb.debian.org/debian unstable main" | sudo tee /etc/apt/sources.list.d/unstable.list
            # - run: sudo apt-get update
            # - run: sudo apt-get install -t unstable -y pkg-config glib2.0 libglib2.0 libglib2.0-dev libgtk-4-1 libgtk-3-0 libgtk-4-dev libgtk-3-dev libwebkit2gtk-4.0-dev
            # - run: sudo apt-get install -t unstable -y pkg-config libglib2.0-dev libgtk-4-dev libgtk-3-dev libwebkit2gtk-4.0-dev libadwaita-1-dev 
            # - run: sudo sh -c 'echo "deb [trusted=yes] http://gb.archive.ubuntu.com/ubuntu jammy main" >> /etc/apt/sources.list'
            - run: cat /etc/apt/sources.list
            - run: sudo apt-get update
            - run: sudo apt-get install -y pkg-config libglib2.0-dev libgtk-4-dev libgtk-3-dev libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev libsoup-3.0-dev libadwaita-1-dev 
            - run: pkg-config --modversion glib-2.0
            - uses: actions/checkout@v4
            - uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                components: clippy
            - run: cargo check
            - run: cargo clippy
    publish_aur_packages:
        name: Publish AUR packages
        runs-on: ubuntu-latest
        needs:
            - check_and_format
        steps:
            - uses: actions/checkout@v4

            - name: Generate PKGBUILDs
              run: ./ci/gen_daemon_pkgbuild_git.py

            - name: Publish power-options-daemon-git to the AUR
              uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
              with:
                pkgname: power-options-daemon-git
                pkgbuild: ./pkgbuilds/daemon-git/PKGBUILD
                commit_username: ${{ secrets.AUR_USERNAME }}
                commit_email: ${{ secrets.AUR_EMAIL }}
                ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
                commit_message: "Automated update on GitHub commit"
                force_push: 'true'