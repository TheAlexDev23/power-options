name: Release Deployment

on:
  push:
    tags:
        "*"

jobs: 
    check:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions-rust-lang/setup-rust-toolchain@v1
            - run: cargo check
    formatting:
        name: cargo fmt
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions-rust-lang/setup-rust-toolchain@v1
              with:
                components: clippy
            - name: Clippy Check
              uses: actions-rust-lang/clippy@v1
    publish_aur_packages:
        name: Publish AUR packages
        runs-on: ubuntu-latest
        needs:
            - check
            - formatting
        steps:
            - uses: actions/checkout@v4

            - name: Generate PKGBUILDs
              run: ./ci/gen_daemon_pkgbuild.py

            - name: Publish power-options-daemon to the AUR
              uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
              with:
                pkgname: power-options-daemon
                pkgbuild: ./pkgbuilds/daemon/PKGBUILD
                commit_username: ${{ secrets.AUR_USERNAME }}
                commit_email: ${{ secrets.AUR_EMAIL }}
                ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
                commit_message: "Automated update on GitHub release"
                force_push: 'true'